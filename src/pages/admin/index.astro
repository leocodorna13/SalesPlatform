---
import AdminLayout from '../../layouts/AdminLayout.astro';
import AdminPanel from '../../components/AdminPanel.astro';
import { supabase, getCurrentUser } from '../../services/supabase';

// Verificar autenticação primeiro
const user = await getCurrentUser();
if (!user) {
  return Astro.redirect('/admin/login?redirect=' + encodeURIComponent(Astro.url.pathname));
}

// Buscar estatísticas para o dashboard
const { data: products, error: productsError } = await supabase
  .from('products')
  .select('id, status, views');

const { data: interested, error: interestedError } = await supabase
  .from('interests')
  .select('id');

// Calcular estatísticas
const totalProducts = products?.length || 0;
const availableProducts = products?.filter(p => p.status === 'available').length || 0;
const soldProducts = products?.filter(p => p.status === 'sold').length || 0;

// Calcular total de visualizações
const totalViews = products?.reduce((sum, product) => sum + (product.views || 0), 0) || 0;
const totalInterested = interested?.length || 0;

const stats = {
  totalProducts,
  availableProducts,
  soldProducts,
  totalViews,
  totalInterested
};
---

<AdminLayout title="Painel Administrativo">
  <AdminPanel stats={stats} />
</AdminLayout>

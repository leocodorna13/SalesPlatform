---
import AdminLayout from '../../layouts/AdminLayout.astro';
import AdminPanel from '../../components/AdminPanel.astro';
import ViewsMetricsCard from '../../components/ViewsMetricsCard.astro';
import { getCurrentUser, getDashboardStats } from '../../services/supabase';

// Verificar autenticação primeiro
const user = await getCurrentUser();
if (!user) {
  return Astro.redirect('/admin/login?redirect=' + encodeURIComponent(Astro.url.pathname));
}

// Definir tipo para as estatísticas
interface Stats {
  totalProducts: number;
  availableProducts: number;
  soldProducts: number;
  interestCount: number;
  totalViews: number;
  mostViewedProducts: Array<{
    id: string;
    title: string;
    views: number;
  }>;
}

// Buscar estatísticas para o dashboard e converter para o tipo correto
const statsResult = await getDashboardStats() as Stats;

// Garantir valores padrão para evitar erros
const stats: Stats = {
  totalProducts: statsResult.totalProducts ?? 0,
  availableProducts: statsResult.availableProducts ?? 0,
  soldProducts: statsResult.soldProducts ?? 0,
  interestCount: statsResult.interestCount ?? 0,
  totalViews: statsResult.totalViews ?? 0,
  mostViewedProducts: statsResult.mostViewedProducts ?? []
};
---

<AdminLayout title="Painel Administrativo">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <div class="lg:col-span-2">
      <AdminPanel stats={stats} />
    </div>
    <div>
      <ViewsMetricsCard 
        title="Métricas de Visualizações" 
        totalViews={stats.totalViews}
        mostViewedProducts={stats.mostViewedProducts}
      />
    </div>
  </div>
</AdminLayout>

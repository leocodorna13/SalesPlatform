---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getSiteSettings, updateSiteSettings, getCurrentUser } from '../../services/supabase';

// Definir interface para as configurações do site
interface SiteSettings {
  id?: number;
  projectName: string;
  heroTitle: string;
  heroDescription: string;
  heroImageUrl: string;
  contactPhone: string;
  contactWhatsapp: string;
  paymentMethods: string;
  whatsappMessage: string;
}

// Verificar se o usuário está autenticado
const user = await getCurrentUser();
if (!user) {
  return Astro.redirect('/admin/login');
}

// Buscar configurações atuais
const settingsData = await getSiteSettings();
const settings: SiteSettings = settingsData || {
  projectName: 'Desapego dos Martins',
  heroTitle: 'Desapego dos Martins',
  heroDescription: 'Produtos de qualidade a preços acessíveis',
  heroImageUrl: '',
  contactPhone: '',
  contactWhatsapp: '',
  paymentMethods: '',
  whatsappMessage: 'Olá! Vi seu produto no site e tenho interesse.'
};

// Processar formulário
let result = { success: false, message: '' };

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    
    // Extrair dados do formulário
    const updatedSettings: SiteSettings = {
      projectName: formData.get('projectName')?.toString() || '',
      heroTitle: formData.get('heroTitle')?.toString() || '',
      heroDescription: formData.get('heroDescription')?.toString() || '',
      heroImageUrl: formData.get('heroImageUrl')?.toString() || settings.heroImageUrl || '',
      contactPhone: formData.get('contactPhone')?.toString() || '',
      contactWhatsapp: formData.get('contactWhatsapp')?.toString() || '',
      paymentMethods: formData.get('paymentMethods')?.toString() || '',
      whatsappMessage: formData.get('whatsappMessage')?.toString() || ''
    };
    
    // Verificar se há um arquivo de imagem
    const heroImageFile = formData.get('heroImageFile') as File;
    const hasImageFile = heroImageFile && heroImageFile.size > 0;
    
    // Atualizar configurações
    result = await updateSiteSettings(updatedSettings, hasImageFile ? heroImageFile : null);
    
    if (result.success) {
      // Atualizar as configurações locais após o sucesso
      const updatedSettingsData = await getSiteSettings();
      if (updatedSettingsData) {
        Object.assign(settings, updatedSettingsData);
      }
    }
  } catch (error) {
    console.error('Erro ao processar formulário:', error);
    result = {
      success: false,
      message: `Erro ao processar formulário: ${error.message}`
    };
  }
}
---

<AdminLayout title="Configurações do Site">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold text-gray-900 mb-6">Configurações do Site</h1>
    
    {result.message && (
      <div class={`p-4 mb-6 rounded-md ${result.success ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}`}>
        {result.message}
      </div>
    )}
    
    <form method="POST" class="space-y-8" enctype="multipart/form-data">
      <!-- Seção: Informações Gerais -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Informações Gerais</h2>
        
        <div class="space-y-6">
          <!-- Nome do Projeto -->
          <div>
            <label for="projectName" class="block text-sm font-medium text-gray-700 mb-1">
              Nome do Projeto
            </label>
            <div class="text-xs text-gray-500 mb-2">
              Este nome será exibido no título das páginas e no rodapé do site.
            </div>
            <input
              type="text"
              id="projectName"
              name="projectName"
              value={settings.projectName}
              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            />
          </div>
          
          <!-- Título do Hero -->
          <div>
            <label for="heroTitle" class="block text-sm font-medium text-gray-700 mb-1">
              Título Principal
            </label>
            <div class="text-xs text-gray-500 mb-2">
              Este título será exibido em destaque na página inicial.
            </div>
            <input
              type="text"
              id="heroTitle"
              name="heroTitle"
              value={settings.heroTitle}
              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            />
          </div>
          
          <!-- Descrição do Hero -->
          <div>
            <label for="heroDescription" class="block text-sm font-medium text-gray-700 mb-1">
              Descrição Principal
            </label>
            <div class="text-xs text-gray-500 mb-2">
              Esta descrição será exibida abaixo do título principal na página inicial.
            </div>
            <textarea
              id="heroDescription"
              name="heroDescription"
              rows="3"
              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            >{settings.heroDescription}</textarea>
          </div>
          
          <!-- Imagem do Hero -->
          <div>
            <label for="heroImageUrl" class="block text-sm font-medium text-gray-700 mb-1">
              Imagem de Fundo
            </label>
            <div class="text-xs text-gray-500 mb-2">
              Esta imagem será exibida como fundo da seção principal na página inicial.
            </div>
            
            <!-- Preview da imagem atual -->
            {settings.heroImageUrl && (
              <div class="mb-3">
                <img 
                  src={settings.heroImageUrl} 
                  alt="Imagem de fundo atual" 
                  class="w-full max-w-md h-40 object-cover rounded-lg shadow-sm"
                />
              </div>
            )}
            
            <!-- Upload de nova imagem -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Fazer upload de nova imagem
                </label>
                <input
                  type="file"
                  id="heroImageFile"
                  name="heroImageFile"
                  accept="image/*"
                  class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100"
                />
              </div>
              
              <div>
                <label for="heroImageUrl" class="block text-sm font-medium text-gray-700 mb-1">
                  Ou use uma URL externa
                </label>
                <input
                  type="text"
                  id="heroImageUrl"
                  name="heroImageUrl"
                  value={settings.heroImageUrl}
                  placeholder="https://exemplo.com/imagem.jpg"
                  class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
                />
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Seção: Informações de Contato -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Informações de Contato</h2>
        
        <div class="space-y-6">
          <!-- Telefone de Contato -->
          <div>
            <label for="contactPhone" class="block text-sm font-medium text-gray-700 mb-1">
              Telefone de Contato
            </label>
            <div class="text-xs text-gray-500 mb-2">
              Este telefone será exibido no rodapé do site para contato.
            </div>
            <input
              type="text"
              id="contactPhone"
              name="contactPhone"
              value={settings.contactPhone}
              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            />
          </div>
          
          <!-- WhatsApp de Contato -->
          <div>
            <label for="contactWhatsapp" class="block text-sm font-medium text-gray-700 mb-1">
              WhatsApp de Contato
            </label>
            <div class="text-xs text-gray-500 mb-2">
              Este número será usado para o botão de WhatsApp no rodapé e nas páginas de produto.
              Formato: 5511999999999 (com código do país e DDD, sem espaços ou caracteres especiais)
            </div>
            <input
              type="text"
              id="contactWhatsapp"
              name="contactWhatsapp"
              value={settings.contactWhatsapp}
              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            />
          </div>
        </div>
      </div>
      
      <!-- Seção: Configurações de Pagamento e Mensagens -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Pagamento e Mensagens</h2>
        
        <div class="space-y-6">
          <!-- Formas de Pagamento -->
          <div>
            <label for="paymentMethods" class="block text-sm font-medium text-gray-700 mb-1">
              Formas de Pagamento
            </label>
            <div class="text-xs text-gray-500 mb-2">
              Estas formas de pagamento serão exibidas nas páginas de produto.
            </div>
            <textarea
              id="paymentMethods"
              name="paymentMethods"
              rows="3"
              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            >{settings.paymentMethods}</textarea>
          </div>
          
          <!-- Mensagem de WhatsApp -->
          <div>
            <label for="whatsappMessage" class="block text-sm font-medium text-gray-700 mb-1">
              Mensagem Padrão do WhatsApp
            </label>
            <div class="text-xs text-gray-500 mb-2">
              Esta mensagem será enviada quando um usuário clicar no botão de WhatsApp em um produto.
            </div>
            <textarea
              id="whatsappMessage"
              name="whatsappMessage"
              rows="3"
              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            >{settings.whatsappMessage}</textarea>
          </div>
        </div>
      </div>
      
      <div class="flex justify-end">
        <button
          type="submit"
          class="inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
        >
          Salvar Configurações
        </button>
      </div>
    </form>
  </div>
</AdminLayout>

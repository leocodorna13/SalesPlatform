---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getSiteSettings, updateSiteSettings, getCurrentUser } from '../../services/supabase';

// Definir interface para as configurações do site
interface SiteSettings {
  id: string;
  heroTitle: string;
  heroDescription: string;
  heroImageUrl: string;
  contactPhone: string;
  contactWhatsapp: string;
  paymentMethods: string;
  whatsappMessage: string;
  projectName: string;
}

// Definir interface para o resultado da operação
interface OperationResult {
  success: boolean;
  message: string;
  data?: SiteSettings;
}

// Definir interface para o resultado da operação de atualização
interface UpdateResult {
  success: boolean;
  message?: string;
  data?: SiteSettings;
}

// Verificar autenticação
const user = await getCurrentUser();
if (!user) {
  return Astro.redirect('/admin/login');
}

// Buscar configurações atuais
const settings = await getSiteSettings() as SiteSettings;

// Verificar se as configurações foram carregadas
if (!settings) {
  return Astro.redirect('/admin/login?error=Não+foi+possível+carregar+as+configurações');
}

// Processar formulário
let result: OperationResult = {
  success: false,
  message: ''
};

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    
    console.log('Processando formulário de configurações');
    
    // Extrair dados do formulário
    const updatedSettings: SiteSettings = {
      id: settings.id,
      projectName: formData.get('projectName') as string || settings.projectName || 'Desapegos',
      heroTitle: formData.get('heroTitle') as string || '',
      heroDescription: formData.get('heroDescription') as string || '',
      heroImageUrl: formData.get('heroImageUrl') as string || '',
      contactPhone: formData.get('contactPhone') as string || '',
      contactWhatsapp: formData.get('contactWhatsapp') as string || '',
      paymentMethods: formData.get('paymentMethods') as string || '',
      whatsappMessage: formData.get('whatsappMessage') as string || ''
    };
    
    console.log('Dados do formulário:', updatedSettings);
    
    // Atualizar configurações
    const updateResult = await updateSiteSettings(updatedSettings) as UpdateResult;
    console.log('Resultado da atualização:', updateResult);
    
    if (updateResult && updateResult.success) {
      result = {
        success: true,
        message: 'Configurações atualizadas com sucesso!',
        data: updateResult.data
      };
      
      // Atualizar as configurações na página
      Object.assign(settings, updateResult.data);
    } else {
      result = {
        success: false,
        message: updateResult?.message || 'Erro ao atualizar configurações. Tente novamente.'
      };
    }
  } catch (error) {
    console.error('Erro ao processar formulário:', error);
    result = {
      success: false,
      message: 'Ocorreu um erro ao processar sua solicitação. Tente novamente.'
    };
  }
}
---

<AdminLayout title="Configurações do Site">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold text-gray-900 mb-6">Configurações do Site</h1>
    
    {result.message && (
      <div class={`p-4 mb-6 rounded-md ${result.success ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}`}>
        {result.message}
      </div>
    )}
    
    <form method="POST" class="space-y-8">
      <!-- Seção: Informações Gerais -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Informações Gerais</h2>
        
        <div class="space-y-6">
          <!-- Nome do Projeto -->
          <div>
            <label for="projectName" class="block text-sm font-medium text-gray-700 mb-1">
              Nome do Projeto
            </label>
            <div class="text-xs text-gray-500 mb-2">
              Este nome será exibido no título das páginas e no rodapé do site.
            </div>
            <input
              type="text"
              id="projectName"
              name="projectName"
              value={settings.projectName || 'Desapegos'}
              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            />
          </div>
          
          <!-- Título do Hero -->
          <div>
            <label for="heroTitle" class="block text-sm font-medium text-gray-700 mb-1">
              Título Principal
            </label>
            <div class="text-xs text-gray-500 mb-2">
              Este título será exibido em destaque na página inicial.
            </div>
            <input
              type="text"
              id="heroTitle"
              name="heroTitle"
              value={settings.heroTitle}
              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            />
          </div>
          
          <!-- Descrição do Hero -->
          <div>
            <label for="heroDescription" class="block text-sm font-medium text-gray-700 mb-1">
              Descrição Principal
            </label>
            <div class="text-xs text-gray-500 mb-2">
              Esta descrição será exibida abaixo do título principal na página inicial.
            </div>
            <textarea
              id="heroDescription"
              name="heroDescription"
              rows="3"
              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            >{settings.heroDescription}</textarea>
          </div>
          
          <!-- URL da Imagem do Hero -->
          <div>
            <label for="heroImageUrl" class="block text-sm font-medium text-gray-700 mb-1">
              URL da Imagem de Fundo
            </label>
            <div class="text-xs text-gray-500 mb-2">
              Esta imagem será exibida como fundo da seção principal na página inicial.
            </div>
            <input
              type="text"
              id="heroImageUrl"
              name="heroImageUrl"
              value={settings.heroImageUrl}
              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            />
          </div>
        </div>
      </div>
      
      <!-- Seção: Informações de Contato -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Informações de Contato</h2>
        
        <div class="space-y-6">
          <!-- Telefone de Contato -->
          <div>
            <label for="contactPhone" class="block text-sm font-medium text-gray-700 mb-1">
              Telefone de Contato
            </label>
            <div class="text-xs text-gray-500 mb-2">
              Este telefone será exibido no rodapé do site para contato.
            </div>
            <input
              type="text"
              id="contactPhone"
              name="contactPhone"
              value={settings.contactPhone}
              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            />
          </div>
          
          <!-- WhatsApp de Contato -->
          <div>
            <label for="contactWhatsapp" class="block text-sm font-medium text-gray-700 mb-1">
              WhatsApp de Contato
            </label>
            <div class="text-xs text-gray-500 mb-2">
              Este número será usado para o botão de WhatsApp no rodapé e nas páginas de produto.
              Formato: 5511999999999 (com código do país e DDD, sem espaços ou caracteres especiais)
            </div>
            <input
              type="text"
              id="contactWhatsapp"
              name="contactWhatsapp"
              value={settings.contactWhatsapp}
              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            />
          </div>
        </div>
      </div>
      
      <!-- Seção: Configurações de Pagamento e Mensagens -->
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Pagamento e Mensagens</h2>
        
        <div class="space-y-6">
          <!-- Formas de Pagamento -->
          <div>
            <label for="paymentMethods" class="block text-sm font-medium text-gray-700 mb-1">
              Formas de Pagamento
            </label>
            <div class="text-xs text-gray-500 mb-2">
              Estas formas de pagamento serão exibidas nas páginas de produto.
            </div>
            <textarea
              id="paymentMethods"
              name="paymentMethods"
              rows="3"
              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            >{settings.paymentMethods}</textarea>
          </div>
          
          <!-- Mensagem de WhatsApp -->
          <div>
            <label for="whatsappMessage" class="block text-sm font-medium text-gray-700 mb-1">
              Mensagem Padrão do WhatsApp
            </label>
            <div class="text-xs text-gray-500 mb-2">
              Esta mensagem será enviada quando um usuário clicar no botão de WhatsApp em um produto.
            </div>
            <textarea
              id="whatsappMessage"
              name="whatsappMessage"
              rows="3"
              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            >{settings.whatsappMessage}</textarea>
          </div>
        </div>
      </div>
      
      <div class="flex justify-end">
        <button
          type="submit"
          class="inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
        >
          Salvar Configurações
        </button>
      </div>
    </form>
  </div>
</AdminLayout>

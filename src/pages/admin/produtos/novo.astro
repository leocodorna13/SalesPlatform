---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import ImageUploader from '../../../components/ImageUploader.astro';
import { getCategories, createProduct } from '../../../services/supabase';

// Buscar categorias
const categories = await getCategories();

// Processar formulário
let success = false;
let error = null;

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    
    // Extrair dados do produto
    const productData = {
      title: formData.get('title')?.toString() || '',
      description: formData.get('description')?.toString() || '',
      price: parseFloat(formData.get('price')?.toString() || '0'),
      category_id: formData.get('category_id')?.toString() || null
    };
    
    // Extrair arquivos de imagem
    const imageFiles = formData.getAll('images');
    
    // Criar produto
    const product = await createProduct(productData, imageFiles);
    
    if (product) {
      success = true;
    } else {
      error = 'Ocorreu um erro ao criar o produto. Tente novamente.';
    }
  } catch (e) {
    console.error('Erro ao criar produto:', e);
    error = 'Ocorreu um erro ao criar o produto. Tente novamente.';
  }
}
---

<AdminLayout title="Novo Produto">
  <div class="mb-6">
    <a href="/admin/produtos" class="text-primary-600 hover:text-primary-800 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Voltar para lista de produtos
    </a>
  </div>

  {success ? (
    <div class="bg-white rounded-lg shadow-md p-6 text-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h2 class="text-2xl font-semibold text-gray-900 mb-2">Produto criado com sucesso!</h2>
      <p class="text-gray-600 mb-6">
        O produto foi adicionado e já está disponível para visualização no site.
      </p>
      <div class="flex justify-center space-x-4">
        <a href="/admin/produtos" class="btn btn-outline">
          Ver lista de produtos
        </a>
        <a href="/admin/produtos/novo" class="btn btn-primary">
          Adicionar outro produto
        </a>
      </div>
    </div>
  ) : (
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-6">Adicionar novo produto</h2>
      
      {error && (
        <div class="bg-red-100 border border-red-200 text-red-800 rounded-md p-4 mb-6">
          {error}
        </div>
      )}
      
      <form method="POST" enctype="multipart/form-data" class="space-y-6" id="product-form">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="title" class="label">Título do produto</label>
            <input 
              type="text" 
              id="title" 
              name="title" 
              required
              class="input"
              placeholder="Ex: Sofá de 3 lugares"
            />
          </div>
          
          <div>
            <label for="price" class="label">Preço (R$)</label>
            <input 
              type="number" 
              id="price" 
              name="price" 
              required
              min="0"
              step="0.01"
              class="input"
              placeholder="Ex: 299.90"
            />
          </div>
        </div>
        
        <div>
          <label for="category_id" class="label">Categoria</label>
          <select 
            id="category_id" 
            name="category_id" 
            required
            class="input"
          >
            <option value="">Selecione uma categoria</option>
            {categories.map((category) => (
              <option value={category.id}>{category.name}</option>
            ))}
          </select>
        </div>
        
        <div>
          <label for="description" class="label">Descrição</label>
          <textarea 
            id="description" 
            name="description" 
            rows="5"
            class="input"
            placeholder="Descreva o produto, estado de conservação, dimensões, etc."
          ></textarea>
        </div>
        
        <ImageUploader />
        
        <div class="flex justify-end space-x-3">
          <a href="/admin/produtos" class="btn btn-outline">
            Cancelar
          </a>
          <button type="submit" class="btn btn-primary">
            Salvar produto
          </button>
        </div>
      </form>
    </div>
  )}
</AdminLayout>

<script is:inline>
  // Nenhum JavaScript adicional necessário
  // O formulário enviará os arquivos diretamente
</script>
